# docker-compose.yml
version: '3.8'

services:
  # --- Orchestrator Service ---
  orchestrator:
    build:
      context: .
      dockerfile: ./src/orchestrator/Dockerfile
    container_name: orchestrator
    ports:
      - "8032:8032"
    environment:
      BOSS_TOKEN: dev-token
      ANALYZER_URL: http://analyzer:8034
      EXECUTOR_URL: http://executor:8035
      RAG_URL: http://rag:8036
      NOTIFIER_URL: http://notifier:8037
      ORCHESTRATOR_CALLBACK_URL: http://orchestrator:8032
      LOG_LEVEL: INFO
      USE_K8S_TOKEN_AUTH: "True"
      K8S_TOKEN_AUDIENCE: https://kubernetes.default.svc.cluster.local 
      K8S_SA_NAME: sentinel-executor-sa 
      K8S_SA_NAMESPACE: sentinel
      K8S_KUBECONFIG_PATH: /app/kubeconfig

    volumes:
      - ./src/auth/auth.py:/app/src/auth/auth.py:ro
      - ./src/executor_agent/whitelist.json:/app/src/executor_agent/whitelist.json:ro
      - /root/kubeconfigs/external-kubeconfig.yaml:/app/kubeconfig:ro

    depends_on:
      - analyzer
      - executor
      - rag
      - notifier
    networks:
      - sentinel_net

  # --- Detector Agent Service ---
  detector:
    build:
      context: .
      dockerfile: ./src/detector_agent/Dockerfile
    container_name: detector
    ports:
      - "8033:8033"
    depends_on:
      - orchestrator
    environment:
      ENABLE_MOCK_MODE: "True"
      ORCHESTRATOR_URL: http://orchestrator:8032
      BOSS_TOKEN: dev-token
      LOG_LEVEL: INFO
      KUBECONFIG: /app/detect_kubeconfig
    networks:
      - sentinel_net
    volumes:
      - /root/sa-kubeconfig:/app/detect_kubeconfig:ro

  # --- Analyzer Agent Service ---
  analyzer:
    build:
      context: .
      dockerfile: ./src/analyzer_agent/Dockerfile
    container_name: analyzer
    ports:
      - "8034:8034"
    environment:
      DISABLE_LLM_INTEGRATION: "True"
      LLM_PROVIDER: "openai"               # openai / gemini / grok 
      QDRANT_URL: "http://qdrant:6333"
      QDRANT_COLLECTION: "analyzer_cache"
      SECRETS_PATH: "/app/secrets.json"
    volumes:
      - ./secrets/secrets.json:/app/secrets.json:ro   # 시크릿 파일 마운트
    depends_on:
      - qdrant
    networks:
      - sentinel_net
    restart: unless-stopped

  # --- Executor Agent Service ---
  executor:
    build:
      context: .
      dockerfile: ./src/executor_agent/Dockerfile
    container_name: executor
    ports:
      - "8035:8035"
    environment:
      DISABLE_K8S_INTEGRATION: "True"
      KUBECONFIG: /app/kubeconfig
    networks:
      - sentinel_net
    volumes:
      - ./src/auth/auth.py:/app/src/auth/auth.py:ro
      - ./src/executor_agent/whitelist.json:/app/src/executor_agent/whitelist.json:ro
      - /root/kubeconfigs/external-kubeconfig.yaml:/app/kubeconfig:ro

  # --- RAG Agent Service ---
  rag:
    build:
      context: .
      dockerfile: ./src/rag_agent/Dockerfile
    container_name: rag
    ports:
      - "8036:8036"
    environment:
      DISABLE_RAG_INTEGRATION: "False"
    networks:
      - sentinel_net
    volumes:
      - ./docs/kubernetes:/app/docs/kubernetes:ro
    depends_on:
      - qdrant

  # --- Slack Notifier Service ---
  notifier:
    build:
      context: .
      dockerfile: ./src/notifier_agent/Dockerfile
    container_name: notifier
    ports:
      - "8037:8037"
    environment:
      DISABLE_SLACK_INTEGRATION: "False"
      SLACK_DEFAULT_CHANNEL: "C0A521EUU4D"
      ORCHESTRATOR_CALLBACK_URL: http://orchestrator:8032/slack/callback
    networks:
      - sentinel_net
    volumes:
      - ./secrets/secrets.json:/app/secrets.json:ro  
  
  # --- Qdrant (Vector DB for cache) ---
  qdrant:
    image: qdrant/qdrant:v1.10.0
    container_name: qdrant
    ports:
      - "6333:6333"   # REST API
      - "6334:6334"   # gRPC
    networks:
      - sentinel_net
    volumes:
      - qdrant_data:/qdrant/storage
    restart: unless-stopped

volumes:
  qdrant_data:

networks:
  sentinel_net:
    driver: bridge